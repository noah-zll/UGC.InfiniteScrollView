# InfiniteScrollView 分组功能设计方案

## 1. 需求分析
给现有的 `InfiniteScrollView` 组件增加分组功能，要求：
- 支持分组显示（Header + Items）。
- 分组可收起/展开。
- 保持高性能（虚拟化渲染）。

## 2. 核心挑战
现有的 `InfiniteScrollView` 设计是基于扁平列表（Flat List）和单一预制体（Single Prefab）的。要实现分组功能，需要解决以下问题：
1.  **数据结构**：如何将层级化数据（Group -> List）映射到 `InfiniteScrollView` 需要的扁平列表。
2.  **多样式支持**：分组标题（Header）和普通列表项（Item）通常样式不同，需要支持多种预制体。
3.  **交互逻辑**：点击标题收起/展开时，需要动态更新列表数据并刷新布局。

## 3. 方案设计

### 3.1 架构调整
不直接修改 `InfiniteScrollView` 的核心布局逻辑（LayoutManager），而是通过**数据适配器模式**来实现。

1.  **底层增强 (`InfiniteScrollView`)**：
    -   扩展对象池，支持多预制体（Multi-Prefab）。
    -   增加 `GetItemType(index)` 回调，用于区分当前索引是标题还是普通项。

2.  **上层封装 (`GroupedDataHelper`)**：
    -   负责维护分组数据结构。
    -   负责将分组数据“拍平”为 `InfiniteScrollView` 可识别的列表。
    -   处理收起/展开逻辑。

### 3.2 详细设计

#### A. InfiniteScrollView 修改
-   **字段新增**：
    -   `List<GameObject> extraPrefabs`：额外的预制体列表（如 HeaderPrefab）。
    -   `Func<int, int> OnGetItemType`：回调函数，输入索引，返回预制体类型索引（0为默认，1为extraPrefabs[0]...）。
-   **逻辑修改**：
    -   `InitializeObjectPool`：需要为每种预制体初始化独立的对象池。
    -   `GetItemFromPool` / `RecycleItem`：根据类型从对应的池中存取。

#### B. 数据结构定义
```csharp
// 分组数据定义
public class GroupData<T>
{
    public string Title;           // 分组标题
    public bool Expanded = true;   // 是否展开
    public List<T> Items;          // 分组内的项
}

// 内部扁平化后的数据包装
public class GroupDisplayData
{
    public bool IsHeader;    // 是否是标题
    public int GroupIndex;   // 所属分组索引
    public int ItemIndex;    // 在分组内的索引（如果是Header则忽略）
    public object Data;      // 原始数据（GroupData 或 ItemData）
}
```

#### C. 扁平化逻辑 (Flattening)
当数据更新或收起/展开时，重新生成扁平列表：
1.  遍历所有分组。
2.  添加分组 Header 到列表。
3.  如果分组是 `Expanded` 状态，遍历添加该分组的所有 Items。
4.  将生成的扁平列表传递给 `InfiniteScrollView.SetData()`.

### 3.3 交互流程
1.  用户点击 Header Item。
2.  Header Item 触发点击事件，传递 Index。
3.  业务层根据 Index 找到对应的 `GroupData`。
4.  切换 `Expanded` 状态。
5.  调用 `Helper.Refresh()` -> 重新拍平数据 -> `scrollView.SetData()`。

## 4. 使用示例

```csharp
// 1. 定义数据 helper
private GroupedDataHelper<MyItemData> groupHelper;

void Start() {
    // 2. 初始化 helper
    groupHelper = new GroupedDataHelper<MyItemData>(scrollView);
    
    // 3. 设置数据
    var groups = new List<GroupData<MyItemData>>();
    // ... 构建数据 ...
    groupHelper.SetData(groups);
    
    // 4. 注册点击事件处理展开/收起
    scrollView.OnItemClicked += HandleItemClick;
}

void HandleItemClick(int index, IScrollViewItem item) {
    if (groupHelper.IsHeader(index)) {
        groupHelper.ToggleGroup(index);
    }
}
```

## 5. 实施计划
1.  **修改 `InfiniteScrollView.cs`**：支持多预制体。
2.  **实现 `GroupedDataHelper.cs`**：实现数据管理和扁平化逻辑。
3.  **创建 Header 预制体**：制作一个简单的分组标题预制体。
4.  **编写示例场景**：演示分组功能。
